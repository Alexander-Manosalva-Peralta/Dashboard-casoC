<!doctype html>
<html lang="es">

<head>
  <meta charset="utf-8" />
  <title>Dashboard Completo — Caso C (Histórico de Consumos y Lecturas)</title>

  <!-- Chart.js para gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
  :root{
    --ucv-red: #C00000;
    --ucv-blue: #003366;
    --accent: #0088CC;
    --bg: #f4f6f9;
    --text-dark: #0f172a;
    --text-muted: #6b7280;
    --card-bg: rgba(255,255,255,0.85);
    --border-light: rgba(0,0,0,0.10);
    --shadow: 0 10px 30px rgba(0,0,0,0.08);
  }

  *{
    box-sizing:border-box;
    font-family: "SF Pro Display", "Inter", system-ui, sans-serif;
  }

  body{
    margin:0;
    background: var(--bg);
    color: var(--text-dark);
    -webkit-font-smoothing: antialiased;
    text-rendering: optimizeLegibility;
  }

  /* ========================= HEADER ========================= */

  header{
    background: linear-gradient(90deg, var(--ucv-blue), var(--ucv-red));
    color:white;
    padding:22px 0;
    box-shadow: 0 8px 20px rgba(0,0,0,0.15);
  }

  h1,h2,h3,h4{
    letter-spacing:-0.5px;
  }
    .wrap{
    display:flex;
    height: calc(100vh - 90px);
  }

  nav{
    width:270px;
    background:rgba(255,255,255,0.55);
    border-right:1px solid var(--border-light);
    padding:25px 18px;
    overflow-y:auto;
    backdrop-filter: blur(20px);
    box-shadow: inset -5px 0 10px rgba(0,0,0,0.06);
  }

  nav h2{
    margin:0 0 16px 0;
    font-size:20px;
    font-weight:700;
    color:var(--ucv-blue);
  }

  .menu-item{
    padding:12px 15px;
    border-radius:10px;
    margin-bottom:10px;
    cursor:pointer;
    font-size:14px;
    color:var(--text-dark);
    font-weight:500;
    background:rgba(255,255,255,0.5);
    border:1px solid rgba(255,255,255,0.25);
    transition: all .25s ease;
  }

  .menu-item:hover{
    background: var(--ucv-blue);
    color:white;
    transform: translateX(4px);
  }

  /* ========================= MAIN ========================= */

  main{
    flex:1;
    padding:28px;
    overflow-y:auto;
  }


  /* =================== CARDS ==================== */

  .card{
    background:var(--card);
    border-radius:14px;
    padding:20px 22px;
    margin-bottom:22px;
    box-shadow:var(--shadow-soft);
    border:1px solid #f1f3f7;
    transition:.25s ease;
  }

  .card:hover{
    transform:translateY(-2px);
    box-shadow:var(--shadow-strong);
  }

  .row{
    display:flex;
    gap:18px;
    flex-wrap:wrap;
  }

  .col{
    flex:1 1 420px;
  }

  h3{
    margin:0 0 6px 0;
    font-size:19px;
    font-weight:700;
    color:var(--ucv-blue);
  }

  small{
    color:var(--muted);
  }

  /* =================== CANVAS ==================== */

  canvas{
    max-height:450px;
    width:100% !important;
    display:block;
  }

  /* =================== TABLAS ==================== */

  .table-wrap{
    max-height:360px;
    overflow:auto;
    border-radius:10px;
    border:1px solid #e5e9ef;
    box-shadow:0 2px 10px rgba(0,0,0,0.03);
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
    background:white;
  }

  th{
    background:#f3f7f9;
    padding:10px;
    text-align:left;
    font-weight:600;
    color:var(--ucv-blue);
  }

  td{
    padding:10px;
    border-bottom:1px solid #eef2f7;
  }

  tr:hover td{
    background:#f8fafc;
  }

  /* =================== DESCRIPCIONES ==================== */

  .desc{
    margin-top:12px;
    color:var(--muted);
    font-size:14px;
    background:#fafcff;
    padding:14px;
    border-radius:10px;
    border:1px solid rgba(10,12,20,0.05);
    line-height:1.5;
  }

  /* =================== KPIs ==================== */

  .kpis{
    display:flex;
    gap:12px;
    flex-wrap:wrap;
    margin-top:12px;
  }

  .kpi{
    background:linear-gradient(180deg,#f8fffb,#f0fdfa);
    padding:16px;
    border-radius:12px;
    min-width:150px;
    box-shadow:0 6px 18px rgba(2,6,23,0.04);
    border:1px solid rgba(0,0,0,0.05);
  }

  .kpi small{
    display:block;
    color:var(--muted);
    font-size:12px;
  }

  .kpi div{
    font-size:19px;
    font-weight:700;
    margin-top:6px;
    color:var(--ucv-blue);
  }

  /* =================== BOTONES ==================== */

  .btn{
    background:var(--accent);
    color:white;
    padding:8px 12px;
    border-radius:8px;
    border:0;
    cursor:pointer;
    font-weight:600;
    font-size:14px;
    transition:.2s ease;
  }

  .btn:hover{
    filter:brightness(1.15);
    transform:translateY(-1px);
  }

  .btn.secondary{
    background:#eef2f2;
    color:var(--title);
  }

  /* =================== RAW PRE ==================== */

  #rawPre{
    background:#0b1220;
    color:#e6eef0;
    padding:14px;
    border-radius:10px;
    max-height:360px;
    overflow:auto;
    font-family:monospace;
    font-size:13px;
    box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
  }

  /* =================== RESPONSIVE ==================== */

  @media (max-width:1100px){
    nav{display:none}
    .wrap{height:auto}
  }
</style>

</head>
<body>

<header>

  <div style="max-width:1200px;margin:0 auto;display:flex;justify-content:space-between;align-items:center">
    <div>
      <h1 style="margin:0;font-size:20px">Dashboard & Informe — Caso C</h1>
      <small style="opacity:.9">Histórico de consumos y lecturas — Ene 2024 a Ago 2025</small>
    </div>
    <div style="text-align:right">
      <small style="opacity:.9">Fecha: Diciembre 2025</small><br>
      <span class="muted-pill" id="dataSourceBadge">Fuente: caso_c_dataset.csv</span>
    </div>
  </div>
</header>

<div class="wrap">
  <nav>
    <h2>Menú / Secciones</h2>
    <div class="menu-item" onclick="goTo('overview')">Resumen & KPIs</div>
    <div class="menu-item" onclick="goTo('raw')">Datos originales (CSV)</div>
    <div class="menu-item" onclick="goTo('fp')">1. Factor de Potencia (FP)</div>
    <div class="menu-item" onclick="goTo('act-react')">2. Energía Activa vs Reactiva</div>
    <div class="menu-item" onclick="goTo('hp-hfp')">3. Hora Punta vs Fuera Punta</div>
    <div class="menu-item" onclick="goTo('bank')">4. Banco de Capacitores (Qc)</div>
    <div class="menu-item" onclick="goTo('pqs')">5. Perfil trimestral P, Q, S</div>
    <div class="menu-item" onclick="goTo('tendencia')">6. Tendencia P mensual</div>
    <div class="menu-item" onclick="goTo('picos')">7. Picos trimestrales</div>
    <div class="menu-item" onclick="goTo('hp-hfp-anual')">8. HP vs HFP anual</div>
    <div class="menu-item" onclick="goTo('penalidades')">9. Penalidades estimadas</div>
    <div class="menu-item" onclick="goTo('md')">10. Máxima Demanda (MD) vs Contratada</div>
    <div class="menu-item" onclick="goTo('proyecciones')">Proyecciones Sep-Dec 2025</div>
    <div class="menu-item" onclick="goTo('conclusiones')">Conclusiones & Recomendaciones</div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.04);margin:12px 0">
    <div style="font-size:13px;color:#cdebe8;margin-bottom:8px">Acciones</div>
    <div style="margin-top:8px">
      <button class="btn" onclick="downloadCSV()">Descargar CSV (usado)</button>
      <button class="btn secondary" onclick="printReport()">Generar PDF / Imprimir</button>
    </div>
  </nav>

  <main id="main">

    <!-- OVERVIEW -->
    <section id="overview" class="card">
      <h3>RESUMEN EJECUTIVO & KPIs</h3>
      <small>Visión rápida de los indicadores principales extraídos del CSV.</small>

      <div class="kpis" id="kpiContainer">
        <!-- KPIs se llenan desde JS -->
      </div>

      <div style="margin-top:12px" class="desc">
        Este dashboard muestra el análisis completo del Caso C — incluye FP, consumos por mes,
        energía HP/HFP, energía reactiva, dimensionamiento del banco de capacitores, proyecciones
        y recomendaciones comerciales. Los cálculos se basan en el CSV situado en <code>./data/caso_c_dataset.csv</code>.
      </div>
    </section>

    <!-- RAW DATA -->
    <section id="raw" class="card">
      <h3>Datos originales (CSV) — Vista reducida</h3>
      <small>Revisa el dataset mes a mes tal como se extrajo del PDF.</small>
      <div style="margin-top:12px" class="table-wrap">
        <pre id="rawPre">Cargando datos...</pre>
      </div>
      <div style="margin-top:10px">
        <button class="btn" onclick="showFullTable()">Ver tabla completa</button>
      </div>
    </section>

    <!-- FP -->
    <section id="fp" class="card">
      <h3>1. Factor de Potencia (FP) — Mensual</h3>
      <canvas id="chartFP"></canvas>
      <div class="desc" id="descFP"></div>

      <h4 style="margin-top:12px">Tabla: FP por mes y penalización (umbral 0.92)</h4>
      <div id="fpTableWrap"></div>
    </section>

    <!-- ACTIVA VS REACTIVA -->
    <section id="act-react" class="card">
      <h3>2. Energía Activa vs Energía Reactiva</h3>
      <canvas id="chartActReact"></canvas>
      <div class="desc" id="descActReact"></div>
    </section>

    <!-- HP vs HFP -->
    <section id="hp-hfp" class="card">
      <h3>3. Distribución Hora Punta (HP) vs Fuera Punta (HFP)</h3>
      <canvas id="chartHPHFP"></canvas>
      <div class="desc" id="descHPHFP"></div>
    </section>

    <!-- BANK -->
    <section id="bank" class="card">
      <h3>4. Dimensionamiento de Banco de Capacitores</h3>
      <small>Se calcula Q actual, Q deseada (FP objetivo) y Qc necesario.</small>
      <div class="row">
        <div class="col">
          <canvas id="chartBank"></canvas>
        </div>
        <div class="col">
          <h4>Tabla: Q actual / Q deseada / Qc (kVAr)</h4>
          <div id="bankTableWrap"></div>
          <div style="margin-top:10px" class="desc">
            FP objetivo por defecto: <b id="fpGoalText">0.95</b>. Puedes cambiarlo en el código o en la UI.
          </div>
        </div>
      </div>
    </section>

    <!-- P Q S -->
    <section id="pqs" class="card">
      <h3>5. Perfil trimestral: P, Q y S</h3>
      <canvas id="chartPQS"></canvas>
      <div class="desc" id="descPQS"></div>
    </section>

    <!-- TENDENCIA P -->
    <section id="tendencia" class="card">
      <h3>6. Tendencia de la Potencia Activa (P) mensual</h3>
      <canvas id="chartTP"></canvas>
      <div class="desc" id="descTP"></div>
    </section>

    <!-- PICOS -->
    <section id="picos" class="card">
      <h3>7. Picos de consumo (máximo por trimestre)</h3>
      <canvas id="chartPicos"></canvas>
      <div class="desc" id="descPicos"></div>
    </section>

    <!-- HP HFP ANUAL -->
    <section id="hp-hfp-anual" class="card">
      <h3>8. HP vs HFP — Comparativo anual</h3>
      <canvas id="chartHPHFPAnual"></canvas>
      <div class="desc" id="descHPHFPAnual"></div>
    </section>

    <!-- PENALIDADES -->
    <section id="penalidades" class="card">
      <h3>9. Estimación ilustrativa de penalidades por FP</h3>
      <canvas id="chartPenalidades"></canvas>
      <div class="desc" id="descPenalidades"></div>
    </section>

    <!-- MD -->
    <section id="md" class="card">
      <h3>10. Máxima Demanda (MD) vs MD contratada (estimada)</h3>
      <canvas id="chartMD"></canvas>
      <div class="desc" id="descMD"></div>
    </section>

    <!-- PROYECCIONES -->
    <section id="proyecciones" class="card">
      <h3>Proyecciones Sep-Dic 2025 (Lineal)</h3>
      <div class="row">
        <div class="col">
          <h4>Proyección Energía Activa Total (kWh)</h4>
          <canvas id="chartProyEa"></canvas>
        </div>
        <div class="col">
          <h4>Proyección Potencia Máxima (kW)</h4>
          <canvas id="chartProyPmax"></canvas>
        </div>
      </div>
      <div class="desc" id="descProy"></div>
    </section>

    <!-- CONCLUSIONES -->
    <section id="conclusiones" class="card">
      <h3>Conclusiones & Recomendaciones</h3>
      <div id="conclText"></div>
    </section>

  </main>
</div>

<footer>
  Dashboard generado a partir de “CASO C – Histórico de Consumos y Lecturas”. Diseñado para presentación a cliente.
</footer>
<!-- ================= PARTE 2/3: PARSER, UTILS y FLUJO INICIAL ================= -->
<script>
/* ========== CONFIG ========== */
const CSV_PATH = './data/caso_c_dataset.csv'; // ruta relativa dentro del proyecto
const FP_UMBRAL = 0.92;
const FP_OBJETIVO = 0.95;
const HORAS_MES = 720; // uso aproximado como en tu especificación

/* ========== Helper DOM ========== */
function _(id){ return document.getElementById(id); }
function goTo(sectionId){
  // scroll suave a la sección, y pequeño highlight
  const el = _(sectionId);
  if(!el) return;
  el.scrollIntoView({behavior:'smooth', block:'start'});
  el.style.transition = 'box-shadow .35s ease';
  el.style.boxShadow = '0 8px 30px rgba(6,22,33,0.08)';
  setTimeout(()=> el.style.boxShadow = '', 900);
}

/* ========== Formatting helpers ========== */
function formatNum(n,dec=2){
  if(n===null || n===undefined || isNaN(n)) return 'n/a';
  // show thousands with comma, period decimal
  return Number(n).toLocaleString('en-US',{minimumFractionDigits:dec, maximumFractionDigits:dec});
}
function safeParseFloat(s){
  if(s===null || s===undefined) return 0;
  // remove spaces, non-number except comma and dot, replace comma thousands
  const cleaned = String(s).replace(/\s+/g,'').replace(/\./g,'').replace(/,/g,'');
  const v = Number(cleaned);
  return isNaN(v) ? 0 : v;
}

/* ========== CSV Parser robusto (adaptado a tu CSV exacto) ==========
   - Espera encabezado: Periodo,Energia_Activa_Total,Energia_Activa_HP,...
   - Detecta delimitador (coma/;), normaliza decimales con coma/miles
   - Mapea exactamente las columnas que nos interesan
   - Devuelve lista ordenada de filas: {Periodo,Mes,Año, Energia_Activa_Total, Energia_Activa_HP, Energia_Activa_HFP, Energia_Reactiva, Potencia_HP, Potencia_HFP}
*/
async function fetchAndParseCSV(path){
  const res = await fetch(path);
  if(!res.ok) throw new Error('HTTP ' + res.status + ' — no se pudo cargar CSV: ' + path);
  let text = await res.text();

  // Normalize BOM and line endings
  text = text.replace(/^\uFEFF/, '').replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim();

  if(!text) throw new Error('CSV vacío o solo espacios');

  // Try detect delimiter: prefer comma, but if semicolons more frequent, use ;
  const firstChunk = text.split('\n').slice(0,6).join('\n');
  const commaCount = (firstChunk.match(/,/g) || []).length;
  const semiCount = (firstChunk.match(/;/g) || []).length;
  const delim = commaCount >= semiCount ? ',' : ';';

  // Split lines and find header
  const lines = text.split('\n').map(l => l.trim()).filter(l => l !== '');
  let headerLine = lines[0];
  let headerIdx = 0;

  // If first line not header, try find header containing "Periodo" or "Energia_Activa_Total"
  if(!/periodo/i.test(headerLine) || !/energia/i.test(headerLine)){
    for(let i=0;i<Math.min(6,lines.length);i++){
      if(/periodo/i.test(lines[i]) || /energia_activ/i.test(lines[i]) || /energia_activatotal/i.test(lines[i])){
        headerLine = lines[i];
        headerIdx = i;
        break;
      }
    }
  }

  const headers = headerLine.split(delim).map(h => h.trim());

  // Normalize headers to canonical keys
  const norm = h => h.toString().normalize('NFKD').replace(/[\u0300-\u036f]/g,'').replace(/\s+/g,'').replace(/[^a-zA-Z0-9_]/g,'').toLowerCase();
  const headerNorm = headers.map(norm);

  // mapping indices
  const idx = {};
  headerNorm.forEach((h,i)=>{
    if(/^periodo$/.test(h) || h.includes('periodo') || h.includes('period')) idx.periodo = i;
    if(h.includes('energia_activatotal') || h.includes('energiaactivatotal') || h.includes('energia_activat')) idx.energia_activatotal = i;
    if(h.includes('energia_activahp') || h.includes('energia_activahora') || h.includes('hora') && h.includes('punta')) idx.energia_activahp = i;
    if(h.includes('energia_activahfp') || h.includes('fuera') || (h.includes('hfp') || (h.includes('fuera') && h.includes('punta')))) idx.energia_activahfp = i;
    if(h.includes('energia_reactiva') || h.includes('reactiva')) idx.energia_reactiva = i;
    if(h.includes('potencia_hp') || (h.includes('potencia') && h.includes('hp')) || (h.includes('hora') && h.includes('punta') && h.includes('potencia'))) idx.potencia_hp = i;
    if(h.includes('potencia_hfp') || (h.includes('potencia') && h.includes('hfp')) || (h.includes('fuera') && h.includes('potencia'))) idx.potencia_hfp = i;
  });

  // Fallback mappings by exact expected names if some are undefined
  const headerJoined = headerNorm.join(',');
  if(idx.periodo === undefined){
    const f = headerNorm.findIndex(h=> h.includes('periodo') || h.includes('period'));
    if(f>=0) idx.periodo = f;
  }
  if(idx.energia_activatotal === undefined){
    const f = headerNorm.findIndex(h=> h.includes('energia') && h.includes('total') || h.includes('activatotal'));
    if(f>=0) idx.energia_activatotal = f;
  }
  // final fallback: assume fixed order if header fails (as last resort)
  const expectedOrder = ['Periodo','Energia_Activa_Total','Energia_Activa_HP','Energia_Activa_HFP','Energia_Reactiva','Potencia_HP','Potencia_HFP'];
  if(Object.keys(idx).length < 4){
    // try mapping by position if header seems minimal
    // only do this if header row has exactly 7 columns matching expected
    if(headers.length >= 6){
      idx.periodo = idx.periodo ?? 0;
      idx.energia_activatotal = idx.energia_activatotal ?? 1;
      idx.energia_activahp = idx.energia_activahp ?? 2;
      idx.energia_activahfp = idx.energia_activahfp ?? 3;
      idx.energia_reactiva = idx.energia_reactiva ?? 4;
      idx.potencia_hp = idx.potencia_hp ?? 5;
      idx.potencia_hfp = idx.potencia_hfp ?? 6;
    }
  }

  // Build rows
  const dataRows = [];
  for(let i = headerIdx + 1; i < lines.length; i++){
    const line = lines[i];
    if(!line) continue;
    const cols = line.split(delim).map(c => c.trim());
    // Some CSV values have thousands comma -6,345. do cleanse later in safeParseFloat
    const row = {
      Periodo: cols[idx.periodo] ?? cols[0] ?? '',
      Energia_Activa_Total: safeParseFloat(cols[idx.energia_activatotal] ?? cols[1] ?? 0),
      Energia_Activa_HP: safeParseFloat(cols[idx.energia_activahp] ?? cols[2] ?? 0),
      Energia_Activa_HFP: safeParseFloat(cols[idx.energia_activahfp] ?? cols[3] ?? 0),
      Energia_Reactiva: safeParseFloat(cols[idx.energia_reactiva] ?? cols[4] ?? 0),
      Potencia_HP: safeParseFloat(cols[idx.potencia_hp] ?? cols[5] ?? 0),
      Potencia_HFP: safeParseFloat(cols[idx.potencia_hfp] ?? cols[6] ?? 0)
    };

    // derive month and year from Periodo (expect format like "Ago-2025" or "Ago-2025")
    const p = row.Periodo || '';
    const parts = p.split(/[-\s]/).map(s=>s.trim());
    row.Mes = parts[0] ? parts[0] : '';
    row.Año = parts[1] ? parseInt(parts[1]) : (parts.length>1 ? parseInt(parts[1]) : null);

    // Accept only if Periodo exists and at least one numeric > 0
    if(row.Periodo && (row.Energia_Activa_Total || row.Energia_Activa_HP || row.Energia_Activa_HFP || row.Energia_Reactiva || row.Potencia_HP || row.Potencia_HFP)){
      dataRows.push(row);
    }
  }

  if(dataRows.length === 0) throw new Error('No se extrajeron filas del CSV. Revisa formato/encabezados.');

  // Sort chronological: by year then month (map months Spanish->num)
  const monthMap = {ene:1,feb:2,mar:3,abr:4,may:5,jun:6,jul:7,ago:8,set:9,sep:9,oct:10,nov:11,dic:12};
  dataRows.forEach(r=>{
    const m = (r.Mes || '').toString().toLowerCase().slice(0,3);
    r._mnum = monthMap[m] || (Number(m) || 0);
    r._year = r.Año || 0;
  });
  dataRows.sort((a,b) => (a._year - b._year) || (a._mnum - b._mnum));

  console.info('CSV parsed rows:', dataRows.length);
  return dataRows;
}

/* ========== UI utilities: download CSV, show full table, print ========== */
function downloadCSV(){
  // use current parsed rows if available
  const rows = window.__PARSED_ROWS || [];
  if(!rows.length){
    alert('No hay datos cargados para descargar.');
    return;
  }
  // build CSV string
  const header = ['Periodo','Energia_Activa_Total','Energia_Activa_HP','Energia_Activa_HFP','Energia_Reactiva','Potencia_HP','Potencia_HFP'];
  const lines = [header.join(',')];
  rows.forEach(r => {
    lines.push([
      `"${r.Periodo}"`,
      r.Energia_Activa_Total,
      r.Energia_Activa_HP,
      r.Energia_Activa_HFP,
      r.Energia_Reactiva,
      r.Potencia_HP,
      r.Potencia_HFP
    ].join(','));
  });
  const csv = lines.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'caso_c_dataset_export.csv';
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 5000);
}

function showFullTable(){
  const rows = window.__PARSED_ROWS || [];
  if(!rows.length){
    alert('No hay datos cargados para mostrar.');
    return;
  }
  const cols = ['Periodo','Energia_Activa_Total','Energia_Activa_HP','Energia_Activa_HFP','Energia_Reactiva','Potencia_HP','Potencia_HFP'];
  let html = '<div style="max-height:420px;overflow:auto"><table><thead><tr>';
  cols.forEach(c => html += `<th>${c}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{
    html += `<tr><td>${r.Periodo}</td><td>${formatNum(r.Energia_Activa_Total)}</td><td>${formatNum(r.Energia_Activa_HP)}</td><td>${formatNum(r.Energia_Activa_HFP)}</td><td>${formatNum(r.Energia_Reactiva)}</td><td>${formatNum(r.Potencia_HP)}</td><td>${formatNum(r.Potencia_HFP)}</td></tr>`;
  });
  html += '</tbody></table></div>';
  const w = window.open('', '_blank', 'width=1000,height=700,top=50,left=50');
  w.document.write('<title>Tabla completa — Caso C</title>');
  w.document.write('<h3>Tabla completa — Caso C</h3>');
  w.document.write(html);
  w.document.close();
}

function printReport(){
  // Prints current page (the dashboard). The user can hide nav if desired.
  window.print();
}

/* ========== MAIN flow: carga y cómputos iniciales ========== */
async function init(){
  try{
    _('rawPre').textContent = 'Cargando CSV...';
    const parsed = await fetchAndParseCSV(CSV_PATH);
    // store globally for utils
    window.__PARSED_ROWS = parsed.map(r => ({
      Periodo: r.Periodo,
      Mes: r.Mes,
      Año: r.Año,
      Energia_Activa_Total: r.Energia_Activa_Total,
      Energia_Activa_HP: r.Energia_Activa_HP,
      Energia_Activa_HFP: r.Energia_Activa_HFP,
      Energia_Reactiva: r.Energia_Reactiva,
      Potencia_HP: r.Potencia_HP,
      Potencia_HFP: r.Potencia_HFP
    }));

    // show preview
    _('rawPre').textContent = window.__PARSED_ROWS.slice(0,20).map(r=> `${r.Periodo} — Ea: ${formatNum(r.Energia_Activa_Total)}, Er: ${formatNum(r.Energia_Reactiva)}, HP: ${formatNum(r.Energia_Activa_HP)}, HFP: ${formatNum(r.Energia_Activa_HFP)}`).join('\n');

    // compute and render (renderCharts will be in PARTE 3)
    computeAndRenderRobust(window.__PARSED_ROWS);
  } catch(err){
    _('rawPre').textContent = 'Error cargando CSV: ' + err.message;
    console.error(err);
  }
}

/* Start the flow (charts rendering in PART 3) */
init();

/* ========== FIN PARTE 2/3 — ahora continua PARTE 3/3 con gráficos y cierre ========== */
/* ================= PARTE 3/3: CÓMPUTOS, GRÁFICOS (Chart.js), TABLAS Y CIERRE ================= */

/* computeAndRenderRobust: toma rows (array de objetos ya parseados) y genera todo */
function computeAndRenderRobust(rows) {
  // Normalize rows (guarantee numbers)
  const mapped = rows.map(r => ({
    Periodo: r.Periodo || r.periodo || '',
    Mes: r.Mes || (r.Periodo ? r.Periodo.split(/[-\s]/)[0] : ''),
    Año: r.Año || (r.Periodo && r.Periodo.split(/[-\s]/)[1] ? parseInt(r.Periodo.split(/[-\s]/)[1]) : null),
    Energia_Activa_Total: Number(r.Energia_Activa_Total || r.Energia_Activa || 0),
    Energia_Activa_HP: Number(r.Energia_Activa_HP || r.Energia_Activa_HP || 0),
    Energia_Activa_HFP: Number(r.Energia_Activa_HFP || r.Energia_Activa_HFP || 0),
    Energia_Reactiva: Number(r.Energia_Reactiva || 0),
    Potencia_HP: Number(r.Potencia_HP || 0),
    Potencia_HFP: Number(r.Potencia_HFP || 0)
  }));

  // Make sure we have chronological order (safe)
  const monthMap = {ene:1,feb:2,mar:3,abr:4,may:5,jun:6,jul:7,ago:8,set:9,sep:9,oct:10,nov:11,dic:12};
  mapped.forEach(r => {
    const m = (r.Mes || '').toString().toLowerCase().slice(0,3);
    r._m = monthMap[m] || 0;
    r._y = r.Año || 0;
  });
  mapped.sort((a,b) => (a._y - b._y) || (a._m - b._m));

  // arrays for charts
  const labels = mapped.map(r => r.Periodo);
  const Ea = mapped.map(r => r.Energia_Activa_Total);
  const EhP = mapped.map(r => r.Energia_Activa_HP);
  const EhFP = mapped.map(r => r.Energia_Activa_HFP);
  const Er = mapped.map(r => r.Energia_Reactiva);
  const pHP = mapped.map(r => r.Potencia_HP);
  const pHFP = mapped.map(r => r.Potencia_HFP);

  // Avoid zeros being strings; ensure numbers
  const toNumArr = a => a.map(x => (x === null || x === undefined) ? 0 : Number(x || 0));
  const _Ea = toNumArr(Ea);
  const _EhP = toNumArr(EhP);
  const _EhFP = toNumArr(EhFP);
  const _Er = toNumArr(Er);
  const _pHP = toNumArr(pHP);
  const _pHFP = toNumArr(pHFP);

  // Factor de potencia por mes (FP = Ea / sqrt(Ea^2 + Er^2))
  const FP = _Ea.map((e, i) => {
    const er = _Er[i] || 0;
    if (e === 0 && er === 0) return null;
    return e / Math.sqrt(e * e + er * er);
  });

  // Penalizaciones (umbral)
  const penal = FP.map(f => (f !== null && f < FP_UMBRAL ? true : false));

  // Potencias medias (P,Q,S) usando horas del mes (HARAS_MES variable)
  const P = _Ea.map(e => e / HORAS_MES);
  const Q = _Er.map(er => er / HORAS_MES);
  const S = P.map((p, i) => Math.sqrt(p * p + Q[i] * Q[i]));

  // Dimensionamiento del banco de capacitores (Qc) por mes
  const Qneeded = P.map((p, i) => {
    const fp = FP[i];
    if (!fp || fp <= 0) return null;
    // limit to avoid numeric issues
    const fpc = Math.max(Math.min(fp, 0.9999), -0.9999);
    const phi_current = Math.acos(fpc);
    const phi_goal = Math.acos(FP_OBJETIVO);
    // Qc = P * (tan(phi_current) - tan(phi_goal))
    return p * (Math.tan(phi_current) - Math.tan(phi_goal));
  });

  // KPIs
  const validFPs = FP.filter(v => v !== null && !isNaN(v));
  const avgFP = validFPs.length ? (validFPs.reduce((a, b) => a + b, 0) / validFPs.length) : null;
  const lastFP = FP[FP.length - 1] || null;
  const maxPotObserved = Math.max(..._pHP.concat(_pHFP));
  const recommendedMD = Math.ceil(maxPotObserved / 10) * 10;

  // Fill KPIs DOM
  _('kpiContainer').innerHTML = `
    <div class="kpi"><small>FP promedio</small><div style="font-weight:700">${avgFP ? formatNum(avgFP,3) : 'n/a'}</div></div>
    <div class="kpi"><small>Último FP</small><div style="font-weight:700">${lastFP ? formatNum(lastFP,3) : 'n/a'}</div></div>
    <div class="kpi"><small>Máx. Potencia Observada</small><div style="font-weight:700">${formatNum(maxPotObserved,2)} kW</div></div>
    <div class="kpi"><small>MD Recomendada</small><div style="font-weight:700">${recommendedMD} kW</div></div>
    <div class="kpi"><small>Banco sugerido (aprox.)</small><div style="font-weight:700">110 kVAr</div></div>
  `;

  // Preview raw
  _('rawPre').textContent = mapped.slice(0,20).map(r => `${r.Periodo} — Ea: ${formatNum(r.Energia_Activa_Total)}, Er: ${formatNum(r.Energia_Reactiva)}, HP: ${formatNum(r.Energia_Activa_HP)}, HFP: ${formatNum(r.Energia_Activa_HFP)}`).join('\n');

  // Build FP table
  let fpTable = '<table><thead><tr><th>Periodo</th><th>E. Activa (kWh)</th><th>E. Reactiva (kVArh)</th><th>FP</th><th>Penalización</th></tr></thead><tbody>';
  mapped.forEach((r, i) => {
    fpTable += `<tr>
      <td>${r.Periodo}</td>
      <td>${formatNum(r.Energia_Activa_Total,2)}</td>
      <td>${formatNum(r.Energia_Reactiva,2)}</td>
      <td>${FP[i] ? formatNum(FP[i],3) : 'n/a'}</td>
      <td>${penal[i] ? 'Sí' : 'No'}</td>
    </tr>`;
  });
  fpTable += '</tbody></table>';
  _('fpTableWrap').innerHTML = fpTable;

  // Bank table
  let bankTable = '<table><thead><tr><th>Periodo</th><th>P (kW)</th><th>Q actual (kVAr)</th><th>Q deseada (kVAr)</th><th>Qc necesario (kVAr)</th></tr></thead><tbody>';
  mapped.forEach((r, i) => {
    const Pval = P[i] || 0;
    const Qactual = Q[i] || 0;
    const Qdeseada = Pval * Math.tan(Math.acos(FP_OBJETIVO));
    const Qc = Qneeded[i] || 0;
    bankTable += `<tr>
      <td>${r.Periodo}</td>
      <td>${formatNum(Pval,2)}</td>
      <td>${formatNum(Qactual,2)}</td>
      <td>${formatNum(Qdeseada,2)}</td>
      <td>${isFinite(Qc) ? formatNum(Qc,2) : 'n/a'}</td>
    </tr>`;
  });
  bankTable += '</tbody></table>';
  _('bankTableWrap').innerHTML = bankTable;

  // Quarter aggregation for picos
  const quarterList = computeQuarterList(mapped);

  // Proyecciones (lineal simple usando últimos 4 puntos)
  const n = _Ea.length;
  const lastN = Math.min(4, n);
  const eaSlice = _Ea.slice(n - lastN, n);
  const mdObserved = mapped.map((_,i) => Math.max(_pHP[i] || 0, _pHFP[i] || 0));
  const mdSlice = mdObserved.slice(n - lastN, n);

  const slopeEa = linearSlope(Array.from({length:lastN}, (_,i)=>i), eaSlice);
  const slopeMd = linearSlope(Array.from({length:lastN}, (_,i)=>i), mdSlice);

  const proyLabels = ['Ago-2025','Sep-2025','Oct-2025','Nov-2025','Dic-2025'];
  const proyEa = [];
  const proyPmax = [];
  const lastEa = _Ea[_Ea.length - 1] || 0;
  const lastPmax = mdObserved[mdObserved.length - 1] || 0;
  for(let i=0;i<proyLabels.length;i++){
    proyEa.push(Math.max(0, lastEa + slopeEa * i));
    proyPmax.push(Math.max(0, lastPmax + slopeMd * i));
  }

  // Conclusions text
  const conclHtml = `
    <p><b>Resumen ejecutivo:</b></p>
    <ul>
      <li>FP promedio: ${avgFP ? formatNum(avgFP,3) : 'n/a'} (umbral: ${FP_UMBRAL}). Meses con penalización: ${penal.filter(Boolean).length} de ${penal.length}.</li>
      <li>Máxima demanda observada: ${formatNum(maxPotObserved,2)} kW. MD recomendada: ${recommendedMD} kW.</li>
      <li>Banco de capacitores sugerido: ~110 kVAr (resultado redondeado, ver tabla por mes).</li>
      <li>Proyección: Consumo mensual (Ea) podría superar los 500,000 kWh en Q4-2025 según tendencia lineal simple.</li>
    </ul>
  `;
  _('conclText').innerHTML = conclHtml;

  // Finally render charts (Chart.js)
  renderCharts({
    labels,
    Ea: _Ea,
    Er: _Er,
    EhP: _EhP,
    EhFP: _EhFP,
    FP,
    P,
    Q,
    S,
    pHP: _pHP,
    pHFP: _pHFP,
    Qneeded,
    quarterList,
    mdObserved,
    proyLabels,
    proyEa,
    proyPmax
  });

  // expose for debugging
  window.__PARSED_ROWS = mapped;
}


/* ---------- renderCharts: crea/actualiza todos los gráficos ---------- */
function renderCharts(payload){
  // ensure global store
  window._chartObjs = window._chartObjs || {};
  function destroy(id){
    if(window._chartObjs[id] && typeof window._chartObjs[id].destroy === 'function'){
      try { window._chartObjs[id].destroy(); } catch(e){ /* ignore */ }
      window._chartObjs[id] = null;
    }
  }

  // Generic options for modern/clean (apple-like) look
  const commonOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: { position: 'top', labels: { boxWidth:12, boxHeight:6, padding:12 } },
      tooltip: {
        callbacks: {
          label: function(ctx){
            const val = ctx.parsed.y ?? ctx.parsed;
            if(isFinite(val)) return `${ctx.dataset.label}: ${formatNum(val,2)}`;
            return `${ctx.dataset.label}: n/a`;
          }
        }
      }
    },
    scales: {
      x: { ticks: { maxRotation: 0, autoSkip: true }, grid: { display:false } },
      y: { grid: { color: 'rgba(15,23,42,0.04)' } }
    }
  };

  // FP chart (line)
  destroy('chartFP');
  window._chartObjs['chartFP'] = new Chart(_('chartFP'), {
    type: 'line',
    data: {
      labels: payload.labels,
      datasets: [
        { label: 'Factor de Potencia (FP)', data: payload.FP.map(v => v===null ? NaN : Number(v)), borderColor: '#0b6cff', backgroundColor: 'rgba(11,108,255,0.08)', tension:0.25, pointRadius:4, spanGaps:true },
        { label: 'Umbral (0.92)', data: payload.labels.map(_=> FP_UMBRAL), borderColor: '#ef4444', borderDash:[6,6], pointRadius:0, fill:false }
      ]
    },
    options: Object.assign({}, commonOptions, { scales: { y: { min: 0.7, max: 1.02, title: { display:true, text:'FP' } } }, interaction: { intersect:false, mode:'index' } })
  });

  // Activa vs Reactiva (dual bar)
  destroy('chartActReact');
  window._chartObjs['chartActReact'] = new Chart(_('chartActReact'), {
    type: 'bar',
    data: {
      labels: payload.labels,
      datasets: [
        { label: 'E. Activa (kWh)', data: payload.Ea, backgroundColor: 'rgba(6,166,162,0.9)' },
        { label: 'E. Reactiva (kVArh)', data: payload.Er, backgroundColor: 'rgba(245,158,11,0.9)' }
      ]
    },
    options: Object.assign({}, commonOptions, { scales: { y: { title: { display:true, text:'kWh / kVArh' } } }, interaction: { mode:'index', intersect:false } })
  });

  // HP vs HFP monthly (stacked grouped bars) — ensure HP/HFP arrays exist
  destroy('chartHPHFP');
  window._chartObjs['chartHPHFP'] = new Chart(_('chartHPHFP'), {
    type: 'bar',
    data: {
      labels: payload.labels,
      datasets: [
        { label: 'HP (kWh)', data: payload.EhP, backgroundColor: 'rgba(239,68,68,0.9)' },
        { label: 'HFP (kWh)', data: payload.EhFP, backgroundColor: 'rgba(99,102,241,0.9)' }
      ]
    },
    options: Object.assign({}, commonOptions, { scales: { y: { title:{display:true,text:'kWh'} } }, interaction: { mode:'index', intersect:false } })
  });

  // Bank chart: Q actual / Q deseada / Qc necesario
  destroy('chartBank');
  window._chartObjs['chartBank'] = new Chart(_('chartBank'), {
    type: 'bar',
    data: {
      labels: payload.labels,
      datasets: [
        { label: 'Q actual (kVAr)', data: payload.Q.map(q => q || 0), backgroundColor: 'rgba(139,92,246,0.9)' },
        { label: 'Q deseada (kVAr) @ FP objetivo', data: payload.P.map(p => p * Math.tan(Math.acos(FP_OBJETIVO))), backgroundColor: 'rgba(6,182,212,0.9)' },
        { label: 'Qc necesario (kVAr)', data: payload.Qneeded.map(q => (q===null||q===undefined)?0:q), backgroundColor: 'rgba(245,158,11,0.9)' }
      ]
    },
    options: Object.assign({}, commonOptions, { scales: { y: { title:{display:true,text:'kVAr'} } }, interaction: { mode:'index', intersect:false } })
  });

  // P,Q,S monthly (line)
  destroy('chartPQS');
  window._chartObjs['chartPQS'] = new Chart(_('chartPQS'), {
    type: 'line',
    data: {
      labels: payload.labels,
      datasets: [
        { label: 'P (kW)', data: payload.P, borderColor: '#0b6cff', backgroundColor: 'rgba(11,108,255,0.08)', tension:0.2 },
        { label: 'Q (kVAr)', data: payload.Q, borderColor: '#f97316', backgroundColor: 'rgba(249,115,22,0.08)', tension:0.2 },
        { label: 'S (kVA)', data: payload.S, borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,0.08)', tension:0.2 }
      ]
    },
    options: Object.assign({}, commonOptions, { scales: { y: { title:{display:true,text:'kW / kVAr / kVA'} } } })
  });

  // Tendencia P mensual (line)
  destroy('chartTP');
  window._chartObjs['chartTP'] = new Chart(_('chartTP'), {
    type: 'line',
    data: { labels: payload.labels, datasets: [{ label:'P (kW)', data: payload.P, borderColor:'#10b981', backgroundColor:'rgba(16,185,129,0.08)', tension:0.25 }]},
    options: Object.assign({}, commonOptions, { scales:{ y:{ title:{display:true,text:'kW'} } } })
  });

  // Picos trimestrales
  destroy('chartPicos');
  const qLabels = payload.quarterList.map(q => q.quarter);
  const qPeaks = payload.quarterList.map(q => q.maxPeak);
  window._chartObjs['chartPicos'] = new Chart(_('chartPicos'), {
    type: 'bar',
    data: { labels: qLabels, datasets: [{ label:'Pico trimestral (kW)', data: qPeaks, backgroundColor: 'rgba(239,68,68,0.9)'}] },
    options: Object.assign({}, commonOptions, { scales:{ y:{ title:{display:true,text:'kW'} } } })
  });

  // HP vs HFP anual (grouped by year)
  destroy('chartHPHFPAnual');
  const years = [...new Set(payload.labels.map(l => (l||'').toString().split('-')[1] || ''))].filter(Boolean).sort();
  const hpByYear = years.map(y => payload.labels.reduce((acc,lab,i) => (lab.includes(y) ? acc + (payload.EhP[i] || 0) : acc), 0));
  const hfpByYear = years.map(y => payload.labels.reduce((acc,lab,i) => (lab.includes(y) ? acc + (payload.EhFP[i] || 0) : acc), 0));
  window._chartObjs['chartHPHFPAnual'] = new Chart(_('chartHPHFPAnual'), {
    type: 'bar',
    data: { labels: years, datasets: [ { label:'HP (kWh)', data: hpByYear, backgroundColor: 'rgba(146,64,14,0.9)' }, { label:'HFP (kWh)', data: hfpByYear, backgroundColor: 'rgba(17,24,39,0.9)' } ] },
    options: Object.assign({}, commonOptions, { scales:{ y:{ title:{display:true,text:'kWh'} } } })
  });

  // Penalidades ilustrativas
  destroy('chartPenalidades');
  const penalValues = payload.FP.map(v => (v && v < FP_UMBRAL) ? (FP_UMBRAL - v) * 1000 : 0);
  window._chartObjs['chartPenalidades'] = new Chart(_('chartPenalidades'), {
    type: 'bar',
    data: { labels: payload.labels, datasets: [{ label:'Indicador penalidad (u.arb)', data: penalValues, backgroundColor: 'rgba(239,68,68,0.9)'}] },
    options: Object.assign({}, commonOptions, { scales:{ y:{ title:{display:true,text:'u.arb.'} } } })
  });

  // MD vs contratada
  destroy('chartMD');
  const mdObserved = payload.mdObserved;
  const mdMax = Math.max(...mdObserved);
  const MD_contratada = Math.ceil(mdMax / 10) * 10;
  window._chartObjs['chartMD'] = new Chart(_('chartMD'), {
    type: 'line',
    data: { labels: payload.labels, datasets: [
      { label:'MD observada (kW)', data: mdObserved, borderColor:'#0b6cff', backgroundColor:'rgba(11,108,255,0.06)', tension:0.2 },
      { label:'MD contratada (kW)', data: payload.labels.map(_ => MD_contratada), borderColor:'#ef4444', borderDash:[6,6], pointRadius:0, fill:false }
    ]},
    options: Object.assign({}, commonOptions, { scales:{ y:{ title:{display:true,text:'kW'} } } })
  });

  // Proyecciones Ea y Pmax
  destroy('chartProyEa'); destroy('chartProyPmax');
  window._chartObjs['chartProyEa'] = new Chart(_('chartProyEa'), {
    type:'line',
    data: { labels: payload.proyLabels, datasets: [{ label:'Ea proyectada (kWh)', data: payload.proyEa, borderColor:'#0b6cff', fill:false }]},
    options: Object.assign({}, commonOptions, { scales:{ y:{ title:{display:true,text:'kWh'} } } })
  });
  window._chartObjs['chartProyPmax'] = new Chart(_('chartProyPmax'), {
    type:'line',
    data: { labels: payload.proyLabels, datasets: [{ label:'Pmax proyectada (kW)', data: payload.proyPmax, borderColor:'#ef4444', fill:false }]},
    options: Object.assign({}, commonOptions, { scales:{ y:{ title:{display:true,text:'kW'} } } })
  });

  // Descriptions under charts (short explanation)
  _('descFP').innerHTML = `Muestra la evolución mensual del Factor de Potencia (FP). Si FP < ${FP_UMBRAL} es considerado penalizable por normativa — ver tabla.`;
  _('descActReact').innerHTML = `Comparación mensual entre Energía Activa (kWh) y Energía Reactiva (kVArh). Un nivel alto de reactiva indica necesidad de compensación.`;
  _('descHPHFP').innerHTML = `Distribución entre Energía consumida en Hora Punta (HP) y Fuera Punta (HFP). Útil para planear gestión de cargas.`;
  _('descPQS').innerHTML = `Perfil mensual de Potencia activa (P), reactiva (Q) y aparente (S).`;
  _('descTP').innerHTML = `Tendencia de P (kW) mes a mes.`;
  _('descPicos').innerHTML = `Picos máximos por trimestre — ayuda a evaluar demanda contratada.`;
  _('descHPHFPAnual').innerHTML = `Comparativo anual de consumo HP vs HFP.`;
  _('descPenalidades').innerHTML = `Estimación ilustrativa de impacto por tener FP por debajo del umbral. No es un cálculo contractual.`;
  _('descMD').innerHTML = `Comparación de la Máxima Demanda observada vs MD contratada (línea punteada).`;

} // end renderCharts


/* ---------- Small helpers used above ---------- */
function computeQuarterList(rows){
  const monthMap = {ene:1,feb:2,mar:3,abr:4,may:5,jun:6,jul:7,ago:8,set:9,sep:9,oct:10,nov:11,dic:12};
  const quarters = {};
  rows.forEach(r => {
    const mon = (r.Mes || '').toString().toLowerCase().slice(0,3);
    const mi = monthMap[mon] || 0;
    const qIdx = mi ? (Math.floor((mi-1)/3) + 1) : 0;
    const key = `${r.Año || ''}Q${qIdx || ''}`;
    if(!quarters[key]) quarters[key] = {Psum:0,Qsum:0,Ssum:0,count:0,peaks:[]};
    const Pval = (r.Energia_Activa_Total || 0) / HORAS_MES;
    const Qval = (r.Energia_Reactiva || 0) / HORAS_MES;
    const Sval = Math.sqrt(Pval*Pval + Qval*Qval);
    quarters[key].Psum += Pval; quarters[key].Qsum += Qval; quarters[key].Ssum += Sval; quarters[key].count += 1; quarters[key].peaks.push(Math.max(Pval, Sval));
  });
  return Object.keys(quarters).filter(k => quarters[k].count>0).sort().map(k => {
    const v = quarters[k];
    return { quarter: k, avgP: v.Psum / v.count, avgQ: v.Qsum / v.count, avgS: v.Ssum / v.count, maxPeak: Math.max(...v.peaks) };
  });
}

function linearSlope(xs, ys){
  if(!xs || !ys || xs.length !== ys.length || xs.length === 0) return 0;
  const n = xs.length;
  const xm = xs.reduce((a,b)=>a+b,0)/n;
  const ym = ys.reduce((a,b)=>a+b,0)/n;
  let num = 0, den = 0;
  for(let i=0;i<n;i++){ num += (xs[i]-xm)*(ys[i]-ym); den += (xs[i]-xm)*(xs[i]-xm); }
  return den === 0 ? 0 : num/den;
}

/* mappedYears helper used earlier (if needed) */
function mappedYears(labels){
  return labels.map(l => {
    const parts = (l || '').toString().split('-');
    return parts.length > 1 ? parts[1] : (/\d{4}/.test(l) ? l.match(/\d{4}/)[0] : '');
  });
}

/* End of PARTE 3/3: close script and HTML */
</script>

</body>
</html>
